<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Content template | Adviser Ratings</title>
  <link type="text/css" rel="stylesheet" href="./style.css">
  <script type="text/javascript" src="data-licensees.js"></script>
  <script type="text/javascript" src="vue.js"></script>
  <script type="text/javascript" src="d3.min.js"></script>
  <script type="text/javascript" src="sk.d3.js"></script>
  <script type="text/javascript" src="data-movementjson.js"></script>
</head>

<body>
  <!-- header start -->
<div class="header">
 <div class="wrapper"> <a href="#" class="logo" id="sitelogo"></a> <ul class="nav-2"> <li> <a href="#"> <img src="./images/nav-img-one.png" alt="Rate an Adviser">Rate an Adviser</a> </li><li> <a href="#" class="find-an-adviser"> <img src="./images/nav-img-two.png" alt="Find an Adviser">Find an Adviser</a> </li><li class="consumer"> <a href="#"> <img src="./images/nav-image-six.png" alt="DIY Personal Finance">DIY Personal Finance</a> </li><li> <a href="#"> <img src="./images/nav-image-four.png" alt="Company lookup">Company lookup</a> </li><li> <a href="#"> <img src="./images/nav-image-five.png" alt="About and FAQ">About &amp; FAQ</a> </li><li> <a href="#"> <img src="./images/nav-image-seven.png" alt="Adviser Signup">Adviser Signup</a> </li><li> <a href="#"> <img src="./images/nav-image-seven.png" alt="Licensee Signup">Licensee Signup</a> </li></ul> <div class="top-nav-highlight-links" style="display: none;"> <a class="top-nav-find-an-adviser" title="Find an adviser">Find an adviser</a> <a href="#" class="top-nav-rate-your-adviser" title="Rate your adviser">Rate your adviser</a> </div><div> <div class="login-section"> <ul> <li> <a title="LOGIN" class="top-nav-adviser-access login-top"><i class="fa fa-sign-in"></i> LOGIN </a> </li></ul> </div></div><a class="mobile-nav-icon" title="MENU"><i class="fa fa-navicon"></i>MENU</a> <a class="top-nav-find-an-adviser-mobile" title="FIND AN ADVISER"><i class="fa fa-search"></i> <br>FIND AN ADVISER</a> <div class="clear"></div></div>
</div>
<!-- header end -->

<div id="vue-init"></div>
<div class="bg-gradient"></div>

<!-- fooder start -->
<div class="footer-1">
 <div class="footer-wrapper"> <div class="footer-column footer-column-first"> <h3>Adviser Ratings</h3> <ul> <li><a href="#" title="Home">Home</a></li><li><a href="#" title="About">About Us</a></li><li><a href="#" title="The Rating System">About the Rating System</a></li><li><a href="#" title="Our Story">Our Story</a></li></ul> </div><div class="footer-column"> <h3>For consumers</h3> <ul> <li><a href="#" title="Rate Adviser">Rate your Adviser</a></li><li><a href="#" title="For consumers">FAQs for Consumers</a></li><li><a data-id="10011" href="#" title="Adviser Index">Adviser Index</a></li><li><a data-id="10013" href="#" title="Suburb Index">Advisers by Suburb</a></li><li><a data-id="10012" href="#" title="Licensee Index">Licensee Index</a></li></ul> </div><div class="footer-column"> <h3>For advisers</h3> <ul> <li><a href="#" title="Register">Join as an Adviser</a></li><li><a href="#" title="Adviser Access">Adviser Access (Login)</a></li><li><a href="#" title="For advisers">FAQs for Advisers</a></li></ul> </div><div class="footer-column footer-column-last"> <h3>Connect with us</h3> <ul> <li><a href="#" title="Facebook"><i class="fa fa-facebook">&nbsp;</i>Facebook</a></li><li><a href="#" title="Twitter"><i class="fa fa-twitter">&nbsp;</i>Twitter</a></li><li><a href="#" title="LinkedIn"><i class="fa fa-linkedin">&nbsp;</i>LinkedIn</a></li><li><a href="#" title="News &amp; Media"><i class="fa fa-rss">&nbsp;</i>News &amp; Media</a></li><li><a href="#" title="Sign up to our newsletter"><i class="fa fa-envelope">&nbsp;</i>Sign up to our newsletter</a></li></ul> </div><div class="clear">&nbsp;</div></div></div><div class="footer-1-mobile"><a href="#" title="Join as an Adviser"><i class="fa fa-plus">&nbsp;</i> Join as an Adviser</a> <div class="clear">&nbsp;</div><a href="#" title="Sign up to our newsletter"><i class="fa fa-envelope">&nbsp;</i> Sign up to our newsletter</a> <h3>CONNECT WITH US</h3><a href="#" class="footer-mobile-facebook" title="Facebook"><i class="fa fa-facebook">&nbsp;</i> Facebook</a><a href="#" class="footer-mobile-twitter" title="Twitter"><i class="fa fa-twitter">&nbsp;</i> Twitter</a> <a href="#" class="footer-mobile-linkedin" title="LinkedIn"><i class="fa fa-linkedin">&nbsp;</i> LinkedIn</a> </div><div class="footer-2"> <div class="footer-wrapper"> <p>While we may facilitate the review and introduction of Advisers, Customers of Adviser Ratings will be responsible for entering into their own agreement with Advisers introduced through our website. Adviser Ratings does not provide personal financial advice nor do we recommend or suggest a particular adviser is right for you. We provide information of a general nature and we do not take into consideration your personal objectives, financial situation or needs. Always consider whether the advice and information you are provided suits your needs. Adviser Ratings does not endorse, accept or adopt the Advisers on our site, the content of any profiles or the comments or discussion in any community forums. For further information about How We Rate Our Advisers, <a href="#" title="The Rating System">click here</a>.</p><p>Per quote in our video, refer <a href="#">KPMG research undertaken for Financial Services Council</a></p><p>Adviser Ratings Pty Ltd (ABN 18 154 273 640 ) (AR 466730 ) is a Corporate Authorised Representative of IPraxis Pty Ltd (ABN 39 114 365 007) the holder of Australian Financial Services Licence No. 329337.</p><p>Level 38, Tower 2, 200 Barangaroo Avenue, Sydney, Barangaroo 2000, Australia</p></div></div><div class="footer-3"> <div class="footer-wrapper"> <p><span>Â© 2015 Adviser Ratings Pty Ltd</span><a href="#" title="Terms of Use">Terms of Use</a> | <a href="#" title="Privacy">Privacy</a> | <a href="#" title="Contact">Contact</a></p></div>
</div>
<!-- footer end -->



<script type="text/x-template" id="main-view">
  <div class="adv-movement__main">
    <div class="adv-movement__content">
      <movement-header
        :selected="selected"
        :region.sync="region"
        :period.sync="period"/>
      <div class="wrapper">
      <transition name="pagetransition" mode="out-in">
        <movement-list
          v-if="!selected"
          :licensees="licensees"
          :region="region"
          :period="period"
          v-on:routeUpdate="routeToItem"/>
        <movement-item
          v-else
          :selected="selected"
          :region="region"
          :period="period"/>
      </transition>
      </div>
    </div>
    <movement-backgrounds :region="region"/>
  </div>
</script>

<script type="text/x-template" id="movement-backgrounds">
  <div class="bg-cover__container">
    <transition name="covertransition" mode="out-in" appear>
      <div key="all" v-if="region === 'all'" style="background-image: url('images/city.jpg')"></div>
      <div key="qld" v-if="region === 'qld'" style="background-image: url('images/qld.jpg')"></div>
      <div key="nsw" v-if="region === 'nsw'" style="background-image: url('images/nsw.jpg')"></div>
      <div key="act" v-if="region === 'act'" style="background-image: url('images/act.jpg')"></div>
      <div key="vic" v-if="region === 'vic'" style="background-image: url('images/vic.jpg')"></div>
      <div key="tas" v-if="region === 'tas'" style="background-image: url('images/tas.jpg')"></div>
      <div key="sa" v-if="region === 'sa'" style="background-image: url('images/sa.jpg')"></div>
      <div key="wa" v-if="region === 'wa'" style="background-image: url('images/wa.jpg')"></div>
      <div key="nt" v-if="region === 'nt'" style="background-image: url('images/nt.jpg')"></div>
    </transition>
  </div>
</script>

<script type="text/x-template" id="movement-header">
  <div class="hero">
    <div class="hero__text">
      <div class="ar-data-logo"></div>
      <div class="pill pill--small">Last updated: 13 May 2018</div>
      <transition name="fadetransition" mode="out-in">
        <h1 key="main" v-if="!selected">Adviser movements across licensees</h1>
        <h1 key="item" v-else>Adviser movements: {{ selected.name }}</h1>
      </transition>
    </div>
    <div class="hero__filters">
      <div class="select_container">
        <select :value="region" @change="updateValue($event, 'region')">
          <option value="all" selected="selected">All states</option>
          <option value="nsw">New South Wales</option>
          <option value="qld">Queensland</option>
          <option value="vic">Victoria</option>
          <option value="wa">Western Australia</option>
          <option value="sa">South Australia</option>
          <option value="nt">Northern Territory</option>
          <option value="act">Australian Capital Territory</option>
          <option value="tas">Tasmania</option>
        </select>
      </div>
      <div class="select_container">
        <select :value="period" @change="updateValue($event, 'period')">
          <option value="m1" selected="selected">1 month</option>
          <option value="m3">3 months</option>
          <option value="m6">6 months</option>
          <option value="m12">12 months</option>
        </select>
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="movement-list">
  <div class="content-main clearfix">

    <div class="item-list__header--mobile">
      <div class="select_container">
        <select v-model="sortBy.valKey">
          <option value="name">Name</option>
          <option value="total">Total</option>
          <option value="gain">Gained</option>
          <option value="loss">Lost</option>
          <option value="change">Net change</option>
        </select>
      </div>
    </div>

    <ul class="item-list" :class="{'item-list--is-ascending': !sortBy.descending}" v-if="licensees">
      <li class="item-list__header">
        <div class="item-list__section item-list__section--logo"
          :class="{'sort--selected': sortBy.valKey === 'name'}">
          <input type="radio" id="sortOption--name"
           name="sortBy" value="name" v-model="sortBy.valKey" @click="selectSortOption($event)"/>
          <label for="sortOption--name">Name</label>
        </div>
        <div class="item-list__section item-list__section--name"
          :class="{'sort--selected': sortBy.valKey === 'total'}">
          <input type="radio" id="sortOption--total"
           name="sortBy" value="total" v-model="sortBy.valKey" @click="selectSortOption($event)"/>
          <label for="sortOption--total">Total advisers</label>
        </div>
        <div class="item-list__section item-list__section--bars"
          :class="{'sort--selected': sortBy.valKey === 'gain'}">
          <input type="radio" id="sortOption--gained"
           name="sortBy" value="gain" v-model="sortBy.valKey" @click="selectSortOption($event)"/>
          <label for="sortOption--gained">Gained</label>
        </div>
        <div class="item-list__section item-list__section--bars"
          :class="{'sort--selected': sortBy.valKey === 'loss'}">
          <input type="radio" id="sortOption--loss"
           name="sortBy" value="loss" v-model="sortBy.valKey" @click="selectSortOption($event)"/>
          <label for="sortOption--loss">Lost</label>
        </div>
        <div class="item-list__section item-list__section--net"
          :class="{'sort--selected': sortBy.valKey === 'change'}">
          <input type="radio" id="sortOption--change"
           name="sortBy" value="change" v-model="sortBy.valKey" @click="selectSortOption($event)"/>
          <label for="sortOption--change">Change</label>
        </div>
        <div class="item-list__section item-list__section--button">
          <div class="button button--tiny white">CSV&nbsp;<i class="fa fa-download" aria-hidden="true"></i></div>
        </div>
      </li>

      <li v-for="licensee in sortedData" v-on:click="routeToItem(licensee.id)">
        <div class="item-list__section item-list__section--logo">
          <div class="company-logo" :style=" { backgroundImage: 'url(' + licensee.logo + ')'}"></div>
        </div>
        <div class="item-list__section item-list__section--name">
          <h5>{{ licensee.name }}</h5>
          <p>{{ licensee.total }} advisers</p>
        </div>
        <div class="item-list__section item-list__section--bars">
          <div :data-percent="percentGain(licensee.movement[region][period].gain)" class="progress-bar bg-green"></div>
          <p>Gained: <span>{{ licensee.movement[region][period].gain }}</span></p>
        </div>
        <div class="item-list__section item-list__section--bars">
          <div :data-percent="percentLoss(licensee.movement[region][period].loss)" class="progress-bar bg-red"></div>
          <p>Lost: <span>{{ licensee.movement[region][period].loss }}</span></p>
        </div>
        <div class="item-list__section item-list__section--net">
          <div :style="{ backgroundColor: gainLoss(licensee)[1], borderColor: gainLoss(licensee)[2], color: gainLoss(licensee)[3]}" class="ellipsed--medium bg-gray-dk">
            {{ licensee.movement[region][period].change }}
          </div>
          <p>{{ gainLoss(licensee)[0] }}</p>
        </div>
        <div class="item-list__section item-list__section--button">
          <div class="button button--tiny bg-gray-dk">view</div>
        </div>
      </li>

    </ul>
  </div>
</script>

<script type="text/x-template" id="movement-item">
  <div class="content-main clearfix">
    <div class="stats-panel clearfix">
      <div class="stats-panel__item">
        <div class="top icon-left">
          <h3><i class="fa fa-user" aria-hidden="true"></i>
            {{ selected.total }}
          </h3>
        </div>
        <div class="bottom">
          <span>Total Advisers</span>
        </div>
      </div>

      <div class="stats-panel__item">
        <div class="top icon-left">
          <h3><i class="fa fa-sign-in" aria-hidden="true"></i>
            {{ selected.movement[region][period].gain }}
          </h3>
        </div>
        <div class="bottom">
          <span>Gained (in this period)</span>
        </div>
      </div>

      <div class="stats-panel__item">
        <div class="top icon-left">
          <h3><i class="fa fa-sign-out" aria-hidden="true"></i>
            {{ selected.movement[region][period].loss }}
          </h3>
        </div>
        <div class="bottom">
          <span>Lost (in this period)</span>
        </div>
      </div>

      <div class="stats-panel__item">
        <div class="top">
          <h3>{{ selected.movement[region][period].gain - selected.movement[region][period].loss }}</h3>
        </div>
        <div class="bottom">
          <span>Net change</span>
        </div>
      </div>
    </div>

    <div class="padded-content txt-center chart__outer">
      <h2>Adviser Movement per licensee</h2>
      <p>Within {{ period.slice(1) }} month/s for {{ region }}</p>
      <div class="chart-container">
        <div class="logo" :style=" { backgroundImage: 'url(' + selected.logo + ')'}"></div>
        <div class="arrow arrow--right bg-green-red-grad">
          <div class="arrow__text">
            <span class="arrow__text--lhs">In</span>
            <span class="arrow__text--rhs">Out</span>
          </div>
        </div>
        <div id="chart"></div>
      </div>
    </div>
  </div>
</script>


<script>
  Vue.component('main-view', {
    template: '#main-view',
    data: function () {
      return {
        licensees,
        region: 'all',
        period: 'm1',
        selected: false,
        sortBy: {
          valKey: 'total',
          descending: true
        }
      }
    },
    methods: {
      getQueryVar: function (item) {
        var svalue = location.search.match(new RegExp('[\?\&]' + item + '=([^\&]*)(\&?)','i'))
        return svalue ? svalue[1] : svalue
      },
      routeToItem: function (id) {
        console.log('fired')
        if (history.pushState) {
          var _this = this
          var newurl = window.location.origin + window.location.pathname + '?id=' + id
          window.history.pushState({path: newurl}, '', newurl)
          this.setSelected(id)
        }
      },
      setSelected: function (id) {
        var getSelected = this.licensees.filter(function (licensee) {
          return licensee.id === parseInt(id)
        })
        this.selected = getSelected[0]
      }
    },
    created: function () {
      var _this = this
      var id = this.getQueryVar('id')
      !id || this.setSelected(id)
      window.addEventListener('popstate',
        function (e) {
          id = _this.getQueryVar('id')
          id ? _this.setSelected(id)
            : (_this.selected = false)
        }
      )
    }
  })
</script>
<script>
  Vue.component('movement-header', {
    template: '#movement-header',
    props: {
      selected: {
        type: [Boolean, Object]
      },
      region: {
        type: String
      },
      period: {
        type: String
      }
    },
    methods: {
      updateValue: function (ev, varName) {
        this.$emit('update:' + varName, ev.target.value)
      }
    }
  })
</script>
<script>
  Vue.component('movement-backgrounds', {
    template: '#movement-backgrounds',
    props: {
      region: {
        type: String
      }
    }
  })
</script>
<script>
  Vue.component('movement-list', {
    template: '#movement-list',
    props: {
      licensees: {
        type: Array
      },
      region: {
        type: String
      },
      period: {
        type: String
      }
    },
    data: function () {
      return {
        sortBy: {
          valKey: 'total',
          descending: true
        }
      }
    },
    methods: {
      selectSortOption: function (e) {
        (e.target.value !== this.sortBy.valKey && this.sortBy.descending)
          || (this.sortBy.descending = !this.sortBy.descending)
                console.log(this.sortedData)
      },
      percentLoss: function (licLoss) {
        return Math.ceil(licLoss / this.highestLoss * 100)
      },
      percentGain: function (licGain) {
        return Math.ceil(licGain / this.highestGain * 100)
      },
      percentLossNet: function (licLoss) {
        return Math.floor(
          (licLoss - this.lowestLoss) /
          (this.highestLoss - this.lowestLoss) * 100
        )
      },
      percentGainNet: function (licGain) {
        return Math.floor(
          (licGain - this.lowestGain) /
          (this.highestGain - this.lowestGain) * 100
        )
      },
      gainLoss: function (lic) {
        var sign = Math.sign(this.calcChange(lic))
        return (!sign)
          ? ['none', '#FFF', '#9aa4b3', '#9aa4b3']
          : (sign === 1)
            ? ['gain', 'transparent', '#00b89f', '#00b89f']
            : ['loss', 'transparent', '#e65472', '#e65472']
      },
      calcChange: function (lic, region, period) {
        return lic.movement[(region || this.region)][(period || this.period)].gain -
               lic.movement[(region || this.region)][(period || this.period)].loss
      },
      getNestedObj: function get (path, obj) {
        return path.reduce(function (xs, x) {
          return xs && xs[x] ? xs[x] : null
        }, obj)
      },
      pathToSortVal: function (c) {
        switch (c || this.sortBy.valKey) {
          case 'gain':
            return ['movement', this.region, this.period, 'gain']
          case 'loss':
            return ['movement', this.region, this.period, 'loss']
          case 'change':
            return ['movement', this.region, this.period, 'change']
          case 'total':
            return 'total'
          case 'name':
            return 'name'
          default:
            return 'total'
        }
      },
      sortData: function (data, sortValPath) {
        var _this = this
        var isPath = Array.isArray(sortValPath)
        return data.slice().sort(function (a, b) {
          a = isPath ? _this.getNestedObj(sortValPath, a) : a[sortValPath]
          b = isPath ? _this.getNestedObj(sortValPath, b) : b[sortValPath]
          return _this.sortBy.descending
            ? (a === b ? 0 : a > b ? 1 : -1) * -1
            : a === b ? 0 : a > b ? 1 : -1
        })
      },
      routeToItem: function (id) {
        this.$emit('routeUpdate', id)
      }
    },
    computed: {
      licenseesMutated: function () {
        var _this = this
        return this.licensees.map(function (lic) {
          Object.keys(lic.movement).forEach(function (region) {
            Object.keys(lic.movement[region]).forEach(function (period) {
              lic.movement[region][period]['change'] = _this.calcChange(lic, region, period)
            })
          })
          return lic
        })
      },
      sortedData: function () {
        console.log(this.licenseesMutated)
        return this.sortData(
          this.licenseesMutated,
          this.pathToSortVal()
        )
      },
      totalRecs: function () {
        return this.licensees.length
      },
      lossArr: function () {
        var _this = this
        return this.licensees.map(function (lic) {
          return lic.movement[_this.region][_this.period].loss
        })
      },
      totalLoss: function () {
        return this.lossArr.reduce(function (a, b) {
          return a + b
        })
      },
      highestLoss: function () {
        return this.lossArr.reduce(function (a, b) {
          return Math.max(a, b)
        })
      },
      lowestLoss: function () {
        return this.lossArr.reduce(function (a, b) {
          return Math.min(a, b)
        })
      },
      gainArr: function () {
        var _this = this
        return this.licensees.map(function (lic) {
          return lic.movement[_this.region][_this.period].gain
        })
      },
      totalGain: function () {
        return this.gainArr.reduce(function (a, b) {
          return a + b
        })
      },
      highestGain: function () {
        return this.gainArr.reduce(function (a, b) {
          return Math.max(a, b)
        })
      },
      lowestGain: function () {
        return this.gainArr.reduce(function (a, b) {
          return Math.min(a, b)
        })
      }
    }
  })
</script>
<script>
  Vue.component('movement-item', {
    template: '#movement-item',
    props: {
      selected: {
        type: [Boolean, Object]
      },
      region: {
        type: String
      },
      period: {
        type: String
      }
    },
    data: function () {
      return {
        movementjson,
        configSankey: {
          margin: { top: 2, left: 2, right: 2, bottom: 2 },
          nodes: {
            dynamicSizeFontNode: {
              enabled: true,
              minSize: 14,
              maxSize: 20
            },
            draggableX: false, // default [ false ]
            draggableY: false, // default [ true ]
            colors: d3.scaleOrdinal(d3.schemeCategory20)
          },
          links: {
            formatValue: function (val) {
              return d3.format(',.0f')(val) + ' Advisers'
            }
          },
          tooltip: {
            infoDiv: true,
            labelSource: 'From:',
            labelTarget: 'To:'
          }
        }
      }
    },
    methods: {
      renderSankey: function (el, config, data) {
        sk.createSankey(el, config, data)
      }
    },
    mounted: function () {
      var _this = this // Adviser movement data here -- wrap the below in async wait - assign returned data to this.movementjson - you can get the licensee id from this.selected.id
      !this.selected || this.renderSankey(
        '#chart', _this.configSankey, _this.movementjson
      )
    },
    updated: function () {
      var _this = this
      var resizeTimer
      window.addEventListener('resize', function(e) {
        var chart = document.getElementById('chart')
        clearTimeout(resizeTimer)
        chart.innerHTML = ''
        objSankey = ''
        resizeTimer = setTimeout(function () {
          _this.renderSankey(
            '#chart',
            _this.configSankey,
            _this.movementjson
          )
        }, 1000)
      })
    }
  })
</script>
<script>

// Do API call for licensees here and wrap the vue init below in async await -- assign returned data to var 'licensees'
  var rWrap = {template: '<main-view/>'}
  new Vue({el: '#vue-init', render: function (createElement) { return createElement(rWrap) }})
</script>

</body>
</html>
